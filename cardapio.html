<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cardápio Digital - Black Piano</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #09090b; color: #f4f4f5; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .payment-option input:checked + div { border-color: #eab308; background-color: rgba(234, 179, 8, 0.1); }
        .desc-limit { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; }
        .card-active:active { transform: scale(0.98); background-color: rgba(255, 255, 255, 0.05); }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 4px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.2s ease-out; }
    </style>
</head>
<body class="pb-24 select-none">

    <header id="header-area" class="relative h-48 bg-gray-800 bg-cover bg-center transition-all duration-500">
        <div class="absolute inset-0 bg-black/60"></div>
        <div class="absolute bottom-0 left-0 p-4 w-full flex items-end justify-between">
            <div class="flex items-center gap-3">
                <img id="store-logo" src="https://via.placeholder.com/60" class="w-16 h-16 rounded-full border-2 border-yellow-500 shadow-lg object-cover">
                <div>
                    <h1 id="store-name" class="text-2xl font-bold text-white tracking-tight">Carregando...</h1>
                    <p id="store-status" class="text-sm text-green-400 font-medium flex items-center gap-1">...</p>
                </div>
            </div>
        </div>
    </header>
    
    <div id="aviso-box" class="bg-yellow-600/20 border-l-4 border-yellow-500 p-3 mx-4 mt-4 text-sm text-yellow-200 hidden"></div>

    <nav class="sticky top-0 z-40 bg-[#09090b]/95 backdrop-blur-sm py-3 mt-2 border-b border-gray-800">
        <ul id="categories-list" class="flex gap-4 overflow-x-auto px-4 hide-scrollbar text-sm font-medium text-gray-400"></ul>
    </nav>

    <main id="products-container" class="p-4 space-y-8 min-h-[50vh]"></main>

    <button onclick="pedirAConta()" class="fixed bottom-24 right-4 bg-gray-800 border border-gray-700 text-white p-3 rounded-full shadow-xl hover:bg-gray-700 transition z-40 flex flex-col items-center">
        <i class="fa-solid fa-receipt text-xl"></i>
        <span class="text-[8px] font-bold uppercase mt-1">Conta</span>
    </button>

    <div id="cart-bar" class="fixed bottom-0 left-0 w-full bg-zinc-900 border-t border-zinc-800 p-4 transform translate-y-full transition-transform duration-300 z-50 shadow-2xl">
        <div class="flex justify-between items-center max-w-2xl mx-auto">
            <div>
                <p class="text-xs text-gray-400">Total do Pedido</p>
                <p id="cart-total" class="text-xl font-bold text-white">R$ 0,00</p>
            </div>
            <button onclick="openCheckout()" class="bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-2 px-6 rounded-lg transition shadow-lg shadow-yellow-500/20">
                Ver Carrinho <span id="cart-count" class="bg-black text-white text-xs px-2 py-0.5 rounded-full ml-1">0</span>
            </button>
        </div>
    </div>

    <div id="modal-detalhes" class="fixed inset-0 z-[70] bg-black/90 hidden flex items-end sm:items-center justify-center p-0 sm:p-4 animate-fade-in">
        <div class="bg-zinc-900 w-full max-w-md rounded-t-2xl sm:rounded-2xl flex flex-col max-h-[90vh] border border-zinc-800 shadow-2xl overflow-hidden relative">
            
            <button onclick="fecharModalDetalhes()" class="absolute top-4 right-4 z-20 bg-black/60 text-white w-8 h-8 rounded-full flex items-center justify-center hover:bg-black/80 transition backdrop-blur-sm">
                <i class="fa-solid fa-times"></i>
            </button>

            <div id="modal-detalhe-img-area" class="h-40 bg-zinc-800 bg-cover bg-center relative shrink-0">
                <div class="absolute inset-0 bg-gradient-to-t from-zinc-900 to-transparent"></div>
            </div>

            <div class="p-5 overflow-y-auto custom-scrollbar flex-1">
                <h2 id="modal-detalhe-nome" class="text-2xl font-bold text-white mb-1 leading-tight">Nome do Produto</h2>
                <p id="modal-detalhe-desc" class="text-sm text-gray-400 mb-4">Descrição do produto...</p>
                
                <div id="area-selecao-tamanho" class="mb-6 hidden">
                    <h3 class="text-xs font-bold text-gray-500 uppercase mb-2">Escolha o Tamanho <span class="text-red-500">*</span></h3>
                    <div id="lista-tamanhos" class="space-y-2"></div>
                </div>

                <div id="area-segundo-sabor" class="mb-6 hidden bg-zinc-800/50 p-3 rounded border border-dashed border-zinc-700">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-xs font-bold text-yellow-500 uppercase"><i class="fa-solid fa-pizza-slice mr-1"></i> 2º Sabor (Meio a Meio)</h3>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <span class="text-[10px] text-gray-400">Ativar</span>
                            <input type="checkbox" id="check-meio-a-meio" onchange="toggleSegundoSabor()" class="accent-yellow-500 w-4 h-4">
                        </label>
                    </div>
                    
                    <div id="container-select-sabor" class="hidden">
                        <p class="text-[10px] text-gray-400 mb-2">O valor final será o do sabor de maior preço.</p>
                        <select id="select-segundo-sabor" onchange="calcularPrecoPizza()" class="w-full bg-zinc-900 border border-zinc-700 rounded p-2 text-white text-sm outline-none focus:border-yellow-500">
                            <option value="">Selecione o 2º sabor...</option>
                        </select>
                    </div>
                </div>

                <div id="area-selecao-adicionais" class="mb-6 hidden">
                    <h3 class="text-xs font-bold text-gray-500 uppercase mb-2">Adicionais</h3>
                    <div id="lista-adicionais" class="space-y-2"></div>
                </div>

                 <div>
                    <h3 class="text-xs font-bold text-gray-500 uppercase mb-2">Observação</h3>
                    <textarea id="modal-detalhe-obs" placeholder="Ex: Sem cebola, capricha no molho..." class="w-full bg-zinc-800 border border-zinc-700 rounded p-3 text-white text-sm outline-none focus:border-yellow-500" rows="2"></textarea>
                </div>
            </div>

            <div class="p-4 bg-zinc-950 border-t border-zinc-800 shrink-0 flex flex-col gap-3">
                <div class="flex justify-between items-center">
                    <span class="text-zinc-400 text-sm font-medium">Total do Item:</span>
                    <div class="text-white font-bold text-xl" id="modal-detalhe-preco">R$ 0,00</div>
                </div>
                <div class="flex gap-3">
                    <button onclick="fecharModalDetalhes()" class="flex-1 py-3 rounded-lg border border-zinc-700 text-zinc-300 font-bold hover:bg-zinc-800 transition">Cancelar</button>
                    <button onclick="confirmarAdicaoCarrinho()" class="flex-[2] bg-yellow-500 hover:bg-yellow-400 text-black font-bold py-3 rounded-lg shadow-lg transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2" id="btn-add-modal">
                        <span>Adicionar</span> <i class="fa-solid fa-cart-plus"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-checkout" class="fixed inset-0 z-[60] bg-black/90 hidden flex items-end sm:items-center justify-center p-0 sm:p-4">
        <div class="bg-zinc-900 w-full max-w-md h-auto max-h-[85vh] rounded-t-2xl sm:rounded-2xl flex flex-col overflow-hidden border border-zinc-800 shadow-2xl">
            
            <div class="p-4 border-b border-zinc-800 flex justify-between items-center bg-zinc-950 shrink-0">
                <h2 class="text-lg font-bold text-white">Finalizar Pedido</h2>
                <button onclick="closeCheckout()" class="text-gray-400 hover:text-white"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar">
                <div id="checkout-items" class="space-y-2"></div>

                <div id="resumo-taxa" class="hidden flex justify-between text-yellow-500 text-sm font-bold border-t border-zinc-800 pt-2">
                    <span>Taxa de Entrega:</span>
                    <span>+ R$ <span id="resumo-taxa-valor">0,00</span></span>
                </div>

                <hr class="border-zinc-800">
                
                <div class="space-y-3">
                    <div>
                        <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Seu Nome</label>
                        <input type="text" id="input-nome" class="w-full bg-zinc-800 border border-zinc-700 rounded p-2 text-white outline-none focus:border-yellow-500 text-sm" placeholder="Como te chamamos?">
                    </div>

                    <div>
                        <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">WhatsApp</label>
                        <input type="tel" id="input-tel" class="w-full bg-zinc-800 border border-zinc-700 rounded p-2 text-white outline-none focus:border-yellow-500 text-sm" placeholder="(00) 00000-0000">
                    </div>
                    
                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Entrega</label>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="setDeliveryType('mesa')" id="btn-mesa" class="p-2 rounded border border-yellow-500 bg-yellow-500/20 text-yellow-500 font-medium text-sm">Na Mesa</button>
                        <button onclick="setDeliveryType('delivery')" id="btn-delivery" class="p-2 rounded border border-zinc-700 text-gray-400 text-sm">Delivery</button>
                    </div>

                    <div id="area-mesa">
                        <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1 mt-2">Nº da Mesa</label>
                        <input type="number" id="input-mesa" class="w-full bg-zinc-800 border border-zinc-700 rounded p-2 text-white outline-none focus:border-yellow-500 text-sm" placeholder="Ex: 10">
                    </div>

                    <div id="area-delivery" class="hidden space-y-2">
                        <div class="grid grid-cols-4 gap-2">
                            <div class="col-span-3">
                                <label class="block text-[10px] font-bold text-gray-500 uppercase">Rua</label>
                                <input type="text" id="delivery-rua" class="w-full bg-zinc-800 border border-zinc-700 rounded p-2 text-white outline-none focus:border-yellow-500 text-sm">
                            </div>
                            <div class="col-span-1">
                                <label class="block text-[10px] font-bold text-gray-500 uppercase">Nº</label>
                                <input type="text" id="delivery-num" class="w-full bg-zinc-800 border border-zinc-700 rounded p-2 text-white outline-none focus:border-yellow-500 text-sm">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-[10px] font-bold text-gray-500 uppercase">Bairro</label>
                                <input type="text" id="delivery-bairro" placeholder="Nome do bairro" class="w-full bg-zinc-800 border border-zinc-700 rounded p-2 text-white outline-none focus:border-yellow-500 text-sm">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-gray-500 uppercase">Região (Taxa)</label>
                                <select id="delivery-taxa-select" onchange="atualizarTaxaEntrega()" class="w-full bg-zinc-800 border border-zinc-700 rounded p-2 text-white outline-none focus:border-yellow-500 text-sm appearance-none cursor-pointer truncate">
                                    <option value="" data-taxa="0">Carregando...</option>
                                </select>
                            </div>
                        </div>
                        
                        <div id="aviso-taxa" class="hidden text-[10px] text-yellow-500 font-bold flex items-center justify-end gap-1">
                            <i class="fa-solid fa-motorcycle"></i> Taxa aplicada: R$ <span id="valor-taxa-visual">0,00</span>
                        </div>

                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 uppercase">Ponto de Referência</label>
                            <input type="text" id="delivery-ref" class="w-full bg-zinc-800 border border-zinc-700 rounded p-2 text-white outline-none focus:border-yellow-500 text-sm" placeholder="Opcional">
                        </div>
                    </div>

                    <hr class="border-zinc-800">

                    <label class="block text-[10px] font-bold text-gray-400 uppercase">Pagamento</label>
                    <div class="grid grid-cols-3 gap-3">
                        <label class="payment-option cursor-pointer"><input type="radio" name="pagamento" value="pix" checked class="hidden" onchange="toggleTroco(false)"><div class="border border-zinc-700 rounded-lg p-2 text-center text-white text-xs font-bold">Pix</div></label>
                        <label class="payment-option cursor-pointer"><input type="radio" name="pagamento" value="cartao" class="hidden" onchange="toggleTroco(false)"><div class="border border-zinc-700 rounded-lg p-2 text-center text-white text-xs font-bold">Cartão</div></label>
                        <label class="payment-option cursor-pointer"><input type="radio" name="pagamento" value="dinheiro" class="hidden" onchange="toggleTroco(true)"><div class="border border-zinc-700 rounded-lg p-2 text-center text-white text-xs font-bold">Dinheiro</div></label>
                    </div>
                    
                    <div id="area-troco" class="hidden mt-2 bg-zinc-800/50 p-3 rounded border border-dashed border-zinc-700">
                        <label class="block text-[10px] font-bold text-yellow-500 uppercase mb-1">Troco para quanto?</label>
                        <input type="number" id="input-troco" class="w-full bg-zinc-950 border border-zinc-700 rounded p-2 text-white outline-none focus:border-yellow-500 text-sm font-mono" placeholder="Ex: 50.00">
                    </div>
                </div>
            </div>

            <div class="p-4 bg-zinc-950 border-t border-zinc-800 shrink-0">
                <button onclick="processarPedido()" id="btn-confirmar" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg shadow-lg hover:bg-green-500 transition active:scale-95 text-sm">
                    Confirmar Pedido
                </button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://nbhpycsfnjgrhnwtzwsy.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5iaHB5Y3Nmbmpncmhud3R6d3N5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkxMTM2NzUsImV4cCI6MjA4NDY4OTY3NX0.LsNVvMG0gWuu7noJk-YnQTpTDRVQMHtqz1Li2nDgAxM';
        const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        const urlParams = new URLSearchParams(window.location.search);
        const LOJA_SLUG = urlParams.get('loja') || 'geral';

        let cart = [];
        let deliveryType = 'mesa';
        let produtosCache = [];
        let taxaEntregaAtual = 0;
        const TAXA_PADRAO_AUTOMATICA = 7.00;

        // Variáveis globais para o Modal de Seleção
        let produtoSelecionadoAtual = null;
        let tamanhoSelecionado = null;
        let adicionaisSelecionados = [];
        let segundoSaborSelecionado = null; // Novo para pizza

        document.addEventListener('DOMContentLoaded', async () => {
            await carregarLoja();
            await carregarProdutos();
            carregarDadosLocais();
            await carregarOpcoesTaxa(); 
        });

        async function carregarOpcoesTaxa() {
            const select = document.getElementById('delivery-taxa-select');
            select.innerHTML = ''; 
            const { data } = await client.from('taxas_entrega').select('*').eq('ativo', true).eq('restaurante_slug', LOJA_SLUG).order('valor');
            if (data && data.length > 0) {
                select.innerHTML = '<option value="" data-taxa="0">Selecione...</option>';
                data.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.bairro; 
                    option.innerText = `${item.bairro} (+R$${parseFloat(item.valor).toFixed(2)})`;
                    option.setAttribute('data-taxa', item.valor);
                    select.appendChild(option);
                });
            } else {
                const option = document.createElement('option');
                option.value = "Taxa Fixa";
                option.innerText = `Fixa (+R$${TAXA_PADRAO_AUTOMATICA.toFixed(2)})`;
                option.setAttribute('data-taxa', TAXA_PADRAO_AUTOMATICA);
                option.selected = true; 
                select.appendChild(option);
                setTimeout(atualizarTaxaEntrega, 200);
            }
        }

        function atualizarTaxaEntrega() {
            const select = document.getElementById('delivery-taxa-select');
            const optionSelecionada = select.options[select.selectedIndex];
            if (!optionSelecionada) { taxaEntregaAtual = 0; } 
            else { taxaEntregaAtual = parseFloat(optionSelecionada.getAttribute('data-taxa')) || 0; }

            const aviso = document.getElementById('aviso-taxa');
            const visual = document.getElementById('valor-taxa-visual');
            const resumoDiv = document.getElementById('resumo-taxa');
            const resumoValor = document.getElementById('resumo-taxa-valor');

            if (taxaEntregaAtual > 0) {
                aviso.classList.remove('hidden');
                visual.innerText = taxaEntregaAtual.toFixed(2);
                resumoDiv.classList.remove('hidden');
                resumoValor.innerText = taxaEntregaAtual.toFixed(2);
            } else {
                aviso.classList.add('hidden');
                resumoDiv.classList.add('hidden');
            }
            updateCartUI();
        }

        async function carregarLoja() {
            const { data } = await client.from('restaurantes').select('*').eq('slug', LOJA_SLUG).single();
            if(data) {
                document.getElementById('store-name').innerText = data.nome;
                document.getElementById('store-status').innerText = data.aberto ? 'Aberto' : 'Fechado';
                if(data.banner_url) document.getElementById('header-area').style.backgroundImage = `url('${data.banner_url}')`;
                if(data.logo_url) document.getElementById('store-logo').src = data.logo_url;
            }
        }
        
        async function carregarProdutos() {
            const { data } = await client.from('produtos').select('*').eq('restaurante_slug', LOJA_SLUG).order('ordem', { ascending: true });
            produtosCache = data || []; 
            renderizarProdutos(produtosCache);
        }

        function renderizarProdutos(produtos) {
            const container = document.getElementById('products-container');
            const nav = document.getElementById('categories-list');
            const porCategoria = {}; 
            const produtosFiltrados = produtos.filter(p => p.restaurante_slug === LOJA_SLUG);
            
            produtosFiltrados.forEach(p => { if(!porCategoria[p.categoria]) porCategoria[p.categoria]=[]; porCategoria[p.categoria].push(p); });
            
            container.innerHTML = ''; nav.innerHTML = '';
            
            for(const [cat, itens] of Object.entries(porCategoria)) {
                nav.innerHTML += `<li onclick="document.getElementById('cat-${cat}').scrollIntoView({behavior: 'smooth'})" class="whitespace-nowrap cursor-pointer hover:text-white mr-4">${cat}</li>`;
                
                const htmlItens = itens.map(p => {
                    const esgotado = p.disponivel === false;
                    const temVariacoes = p.variacoes && p.variacoes.length > 0;
                    const textoPreco = temVariacoes ? `<span class="text-xs text-gray-400 font-normal">A partir de</span> <br> R$ ${parseFloat(p.preco).toFixed(2)}` : `R$ ${parseFloat(p.preco).toFixed(2)}`;

                    return `
                    <div onclick="${esgotado ? '' : `abrirModalSelecao('${p.id}')`}" class="flex gap-4 bg-zinc-900/50 p-3 rounded-lg border border-zinc-800 mb-3 relative overflow-hidden card-active transition-all cursor-pointer">
                        ${p.mostrar_promo ? '<div class="absolute top-0 right-0 bg-yellow-500 text-black text-[9px] font-black px-2 py-1 rounded-bl-lg">PROMO</div>' : ''}
                        <img src="${p.imagem_url || 'https://via.placeholder.com/80'}" class="w-24 h-24 rounded-lg object-cover flex-shrink-0 ${esgotado ? 'grayscale opacity-50' : ''}">
                        <div class="flex-1 flex flex-col justify-between min-w-0 py-1">
                            <div>
                                <h3 class="font-bold text-white text-sm truncate">${p.nome}</h3>
                                <p class="text-[11px] text-gray-500 desc-limit leading-tight mt-1">${p.descricao||''}</p>
                            </div>
                            <div class="flex justify-between items-end mt-2">
                                <div class="text-yellow-500 font-bold text-sm leading-tight">${textoPreco}</div>
                                ${esgotado 
                                    ? '<span class="text-[9px] bg-red-900/30 text-red-500 font-black px-2 py-1 rounded border border-red-900">ESGOTADO</span>' 
                                    : `<div class="bg-yellow-500 w-8 h-8 rounded-full text-black flex items-center justify-center shadow-lg"><i class="fa-solid fa-plus text-xs"></i></div>`
                                }
                            </div>
                        </div>
                    </div>`;
                }).join('');
                container.innerHTML += `<div id="cat-${cat}" class="mb-6 pt-2"><h2 class="text-lg font-bold text-white mb-2 border-l-4 border-yellow-500 pl-2 tracking-tight">${cat}</h2>${htmlItens}</div>`;
            }
        }

        // --- LÓGICA DO MODAL DE SELEÇÃO ---

        function abrirModalSelecao(id) {
            const prod = produtosCache.find(x => x.id === id);
            if (!prod) return;

            produtoSelecionadoAtual = prod;
            tamanhoSelecionado = null;
            adicionaisSelecionados = [];
            segundoSaborSelecionado = null;

            document.getElementById('modal-detalhe-nome').innerText = prod.nome;
            document.getElementById('modal-detalhe-desc').innerText = prod.descricao || '';
            const imgArea = document.getElementById('modal-detalhe-img-area');
            if(prod.imagem_url) {
                imgArea.style.backgroundImage = `url('${prod.imagem_url}')`;
                imgArea.style.display = 'block';
            } else {
                imgArea.style.display = 'none';
            }
            document.getElementById('modal-detalhe-obs').value = '';

            // Tamanhos
            const areaTam = document.getElementById('area-selecao-tamanho');
            const listaTam = document.getElementById('lista-tamanhos');
            listaTam.innerHTML = '';
            
            if (prod.variacoes && prod.variacoes.length > 0) {
                areaTam.classList.remove('hidden');
                prod.variacoes.sort((a,b) => a.preco - b.preco).forEach((v, idx) => {
                    const div = document.createElement('label');
                    div.className = "flex justify-between items-center bg-zinc-800 p-3 rounded cursor-pointer border border-transparent hover:border-yellow-500 transition";
                    div.innerHTML = `
                        <div class="flex items-center gap-3">
                            <input type="radio" name="tamanho_escolha" value="${idx}" onchange="selecionarTamanho(${idx})" class="accent-yellow-500 w-4 h-4">
                            <span class="text-white text-sm font-bold">${v.nome}</span>
                        </div>
                        <span class="text-yellow-500 font-mono text-sm">R$ ${parseFloat(v.preco).toFixed(2)}</span>
                    `;
                    listaTam.appendChild(div);
                });
            } else {
                areaTam.classList.add('hidden');
                tamanhoSelecionado = { nome: null, preco: prod.preco };
            }

            // PIZZA MEIO A MEIO
            const areaPizza = document.getElementById('area-segundo-sabor');
            const checkPizza = document.getElementById('check-meio-a-meio');
            const selectPizza = document.getElementById('select-segundo-sabor');
            
            if(prod.categoria.toLowerCase().includes('pizza')) {
                areaPizza.classList.remove('hidden');
                checkPizza.checked = false;
                checkPizza.disabled = false; // garante que o checkbox esteja habilitado ao abrir
                document.getElementById('container-select-sabor').classList.add('hidden');
                selectPizza.value = "";
                segundoSaborSelecionado = null;

                selectPizza.innerHTML = '<option value="">Selecione o 2º sabor...</option>';
                const outrasPizzas = produtosCache.filter(p => 
                    p.categoria === prod.categoria && 
                    p.id !== prod.id && 
                    p.disponivel
                );
                
                outrasPizzas.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.id;
                    opt.text = p.nome;
                    selectPizza.appendChild(opt);
                });
            } else {
                areaPizza.classList.add('hidden');
            }

            // Adicionais
            const areaAdd = document.getElementById('area-selecao-adicionais');
            const listaAdd = document.getElementById('lista-adicionais');
            listaAdd.innerHTML = '';

            if (prod.adicionais && prod.adicionais.length > 0) {
                areaAdd.classList.remove('hidden');
                prod.adicionais.forEach((a, idx) => {
                    const div = document.createElement('label');
                    div.className = "flex justify-between items-center bg-zinc-800 p-3 rounded cursor-pointer border border-transparent hover:border-zinc-600 transition";
                    div.innerHTML = `
                        <div class="flex items-center gap-3">
                            <input type="checkbox" onchange="toggleAdicional(${idx}, this.checked)" class="accent-green-500 w-4 h-4 rounded">
                            <span class="text-white text-sm">${a.nome}</span>
                        </div>
                        <span class="text-green-400 font-mono text-sm">+ R$ ${parseFloat(a.preco).toFixed(2)}</span>
                    `;
                    listaAdd.appendChild(div);
                });
            } else {
                areaAdd.classList.add('hidden');
            }

            atualizarTotalModal();
            document.getElementById('modal-detalhes').classList.remove('hidden');
        }

        function fecharModalDetalhes() {
            document.getElementById('modal-detalhes').classList.add('hidden');
        }

        function selecionarTamanho(idx) {
            if(!produtoSelecionadoAtual || !produtoSelecionadoAtual.variacoes) return;
            tamanhoSelecionado = produtoSelecionadoAtual.variacoes[idx];

            // Se for pizza e o tamanho selecionado for 'cone', desabilita a opção de 2º sabor
            try {
                if (produtoSelecionadoAtual.categoria && produtoSelecionadoAtual.categoria.toLowerCase().includes('pizza') && tamanhoSelecionado && tamanhoSelecionado.nome && tamanhoSelecionado.nome.toLowerCase() === 'cone') {
                    const check = document.getElementById('check-meio-a-meio');
                    const container = document.getElementById('container-select-sabor');
                    const select = document.getElementById('select-segundo-sabor');
                    if (check) { check.checked = false; check.disabled = true; }
                    if (container) container.classList.add('hidden');
                    if (select) select.value = "";
                    segundoSaborSelecionado = null;
                } else {
                    const check = document.getElementById('check-meio-a-meio');
                    if (check) check.disabled = false; // re-habilita para outros tamanhos
                }
            } catch (e) {
                console.warn('Erro ao aplicar regra cone/meio-a-meio', e);
            }

            atualizarTotalModal();
        }

        function toggleAdicional(idx, checked) {
            if(!produtoSelecionadoAtual) return;
            const add = produtoSelecionadoAtual.adicionais[idx];
            if (checked) {
                adicionaisSelecionados.push(add);
            } else {
                adicionaisSelecionados = adicionaisSelecionados.filter(x => x.nome !== add.nome);
            }
            atualizarTotalModal();
        }

        function toggleSegundoSabor() {
            const check = document.getElementById('check-meio-a-meio');
            const container = document.getElementById('container-select-sabor');
            const select = document.getElementById('select-segundo-sabor');
            
            if(check.checked) {
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
                select.value = "";
                segundoSaborSelecionado = null;
            }
            atualizarTotalModal();
        }

        function calcularPrecoPizza() {
            const select = document.getElementById('select-segundo-sabor');
            const idSabor2 = select.value;
            if(!idSabor2) { segundoSaborSelecionado = null; } 
            else { segundoSaborSelecionado = produtosCache.find(p => p.id == idSabor2); }
            atualizarTotalModal();
        }

        function atualizarTotalModal() {
            let total = 0;
            const btn = document.getElementById('btn-add-modal');
            
            if (produtoSelecionadoAtual.variacoes && produtoSelecionadoAtual.variacoes.length > 0 && !tamanhoSelecionado) {
                btn.disabled = true;
                btn.innerText = "Escolha um tamanho";
                document.getElementById('modal-detalhe-preco').innerText = "---";
                return;
            }

            let precoBase = 0;
            
            if (tamanhoSelecionado) {
                let preco1 = parseFloat(tamanhoSelecionado.preco);
                if (segundoSaborSelecionado) {
                    // Tenta achar o MESMO tamanho na Pizza 2
                    const variacaoSabor2 = segundoSaborSelecionado.variacoes.find(v => v.nome === tamanhoSelecionado.nome);
                    if (variacaoSabor2) {
                        let preco2 = parseFloat(variacaoSabor2.preco);
                        precoBase = Math.max(preco1, preco2);
                    } else {
                        precoBase = preco1; 
                    }
                } else {
                    precoBase = preco1;
                }
            } else {
                precoBase = parseFloat(produtoSelecionadoAtual.preco);
            }

            total += precoBase;
            adicionaisSelecionados.forEach(a => total += parseFloat(a.preco));
            
            document.getElementById('modal-detalhe-preco').innerText = `R$ ${total.toFixed(2)}`;
            btn.disabled = false;
            btn.innerText = "Adicionar";
        }

        function confirmarAdicaoCarrinho() {
            if(!produtoSelecionadoAtual) return;
            
            // Recalcula para garantir
            let precoFinal = 0;
            
            if (tamanhoSelecionado) {
                let p1 = parseFloat(tamanhoSelecionado.preco);
                if(segundoSaborSelecionado) {
                    const v2 = segundoSaborSelecionado.variacoes.find(v => v.nome === tamanhoSelecionado.nome);
                    let p2 = v2 ? parseFloat(v2.preco) : p1;
                    precoFinal = Math.max(p1, p2);
                } else {
                    precoFinal = p1;
                }
            } else {
                precoFinal = parseFloat(produtoSelecionadoAtual.preco);
            }
            
            adicionaisSelecionados.forEach(a => precoFinal += parseFloat(a.preco));
            const obs = document.getElementById('modal-detalhe-obs').value;

            let nomeFinal = produtoSelecionadoAtual.nome;
            if(segundoSaborSelecionado) {
                nomeFinal = `½ ${produtoSelecionadoAtual.nome} / ½ ${segundoSaborSelecionado.nome}`;
            }

            const itemCarrinho = {
                id: produtoSelecionadoAtual.id,
                nome: nomeFinal,
                preco: precoFinal,
                tamanho: tamanhoSelecionado && tamanhoSelecionado.nome ? tamanhoSelecionado.nome : null,
                adicionais: adicionaisSelecionados,
                obs: obs,
                cartId: Date.now() 
            };

            cart.push(itemCarrinho);
            updateCartUI();
            
            if(window.navigator.vibrate) window.navigator.vibrate(50);
            fecharModalDetalhes();
        }

        function updateCartUI() {
            const totalProdutos = cart.reduce((a,b)=>a+b.preco,0);
            const totalFinal = totalProdutos + (deliveryType === 'delivery' ? taxaEntregaAtual : 0);
            document.getElementById('cart-total').innerText = 'R$ ' + totalFinal.toFixed(2);
            document.getElementById('cart-count').innerText = cart.length;
            const bar = document.getElementById('cart-bar');
            cart.length > 0 ? bar.classList.remove('translate-y-full') : bar.classList.add('translate-y-full');
        }

        function renderCheckoutItems() {
            document.getElementById('checkout-items').innerHTML = cart.map((item, index) => {
                let detalhesHtml = '';
                if(item.tamanho) detalhesHtml += `<span class="text-[10px] bg-zinc-700 px-1 rounded mr-1">${item.tamanho}</span>`;
                if(item.adicionais && item.adicionais.length > 0) detalhesHtml += `<span class="text-[10px] text-gray-400">+ ${item.adicionais.map(a=>a.nome).join(', ')}</span>`;
                if(item.obs) detalhesHtml += `<div class="text-[10px] text-yellow-500 italic mt-0.5">Obs: ${item.obs}</div>`;

                return `
                <div class="flex justify-between bg-zinc-800 p-3 rounded-lg mb-2 border border-zinc-700">
                    <div class="flex-1">
                        <div class="text-white text-sm font-bold">${item.nome}</div>
                        <div class="leading-tight">${detalhesHtml}</div>
                        <div class="text-yellow-500 font-mono text-xs mt-1">R$ ${item.preco.toFixed(2)}</div>
                    </div>
                    <button onclick="event.stopPropagation(); cart.splice(${index},1);updateCartUI();renderCheckoutItems()" class="text-red-400 hover:text-red-300 p-2 self-center">
                        <i class="fa-solid fa-trash text-sm"></i>
                    </button>
                </div>`;
            }).join('');
            
            if(cart.length === 0) closeCheckout();
        }

        // --- FUNÇÃO NOVA: Mostrar/Esconder campo de Troco ---
        function toggleTroco(show) {
            const area = document.getElementById('area-troco');
            const input = document.getElementById('input-troco');
            if(show) {
                area.classList.remove('hidden');
            } else {
                area.classList.add('hidden');
                input.value = ''; // Limpa o valor se trocar para Pix/Cartão
            }
        }

        async function processarPedido() {
            if (cart.length === 0) return;
            const nome = document.getElementById('input-nome').value;
            const telefone = document.getElementById('input-tel').value;
            const mesa = document.getElementById('input-mesa').value;
            // Pega o valor do radio selecionado
            const radioPagamento = document.querySelector('input[name="pagamento"]:checked');
            const metodoPagamento = radioPagamento ? radioPagamento.value : 'pix';

            if (!nome) return alert('Informe seu nome.');
            if (!telefone) return alert('Informe seu WhatsApp para avisarmos sobre o pedido.');
            
            let enderecoFinal = "";
            let taxaAplicada = 0;

            if (deliveryType === 'delivery') {
                const rua = document.getElementById('delivery-rua').value;
                const num = document.getElementById('delivery-num').value;
                const bairroDigitado = document.getElementById('delivery-bairro').value; 
                const selectTaxa = document.getElementById('delivery-taxa-select');
                const nomeRegiaoTaxa = selectTaxa.options[selectTaxa.selectedIndex]?.text || ""; 
                const ref = document.getElementById('delivery-ref').value;

                if (!rua || !num || !bairroDigitado) return alert('Preencha rua, número e bairro.');
                if (taxaEntregaAtual === 0 && selectTaxa.value === "") return alert('Selecione a região de entrega para calcular a taxa.');
                
                enderecoFinal = `Rua: ${rua}, Nº: ${num}, Bairro: ${bairroDigitado} | Ref: ${ref}`;
                enderecoFinal += ` | Região Selecionada: ${nomeRegiaoTaxa}`;
                taxaAplicada = taxaEntregaAtual;
            } else {
                if (!mesa) return alert('Informe o número da mesa.');
                taxaAplicada = 0;
            }

            // --- LÓGICA DE PAGAMENTO E TROCO ATUALIZADA ---
            let stringPagamento = metodoPagamento === 'cartao' ? 'Cartão' : 'Pix';
            
            if (metodoPagamento === 'dinheiro') {
                const valorTroco = document.getElementById('input-troco').value;
                if (!valorTroco) {
                    if(!confirm('Você selecionou Dinheiro mas não informou para quanto é o troco. O entregador não levará troco. Deseja continuar?')) return;
                    stringPagamento = 'Dinheiro (Sem troco)';
                } else {
                    stringPagamento = `Dinheiro (Troco p/ R$ ${valorTroco})`;
                }
            }

            const btn = document.getElementById('btn-confirmar');
            btn.disabled = true; btn.innerText = "Enviando...";

            const totalProdutos = cart.reduce((acc, item) => acc + item.preco, 0);
            const totalComTaxa = totalProdutos + taxaAplicada;

            try {
                const { error } = await client.from('pedidos').insert({
                    restaurante_slug: LOJA_SLUG,
                    cliente: nome,
                    mesa: deliveryType === 'mesa' ? mesa : null,
                    tipo_entrega: deliveryType,
                    itens: JSON.stringify(cart),
                    observacoes: enderecoFinal,
                    telefone: telefone,
                    total: totalComTaxa, 
                    status: 'pendente',
                    status_pagamento: 'pendente',
                    metodo_pagamento: stringPagamento // Envia a string formatada
                });

                if (error) throw error;
                alert('Pedido enviado para a cozinha!');
                
                localStorage.setItem('rest_nome', nome);
                localStorage.setItem('rest_tel', telefone);
                if(deliveryType === 'mesa') localStorage.setItem('rest_mesa', mesa);
                
                cart = []; updateCartUI(); closeCheckout();
            } catch (e) { alert('Erro: ' + e.message); } finally { btn.disabled = false; btn.innerText = "Confirmar Pedido"; }
        }

        async function pedirAConta() {
            const mesa = localStorage.getItem('rest_mesa');
            if (!mesa) return alert('Nenhuma mesa identificada.');
            if(confirm(`Deseja solicitar a conta para a Mesa ${mesa}?`)) {
                await client.from('pedidos').update({ chamado_conta: true }).eq('mesa', mesa).eq('restaurante_slug', LOJA_SLUG).neq('status', 'concluido');
                alert('Garçom notificado!');
            }
        }

        function openCheckout() { document.getElementById('modal-checkout').classList.remove('hidden'); renderCheckoutItems(); }
        function closeCheckout() { document.getElementById('modal-checkout').classList.add('hidden'); }
        function setDeliveryType(t) {
            deliveryType = t;
            document.getElementById('area-mesa').classList.toggle('hidden', t !== 'mesa');
            document.getElementById('area-delivery').classList.toggle('hidden', t !== 'delivery');
            document.getElementById('btn-mesa').className = t==='mesa' ? "p-2 rounded border border-yellow-500 bg-yellow-500/20 text-yellow-500 text-sm" : "p-2 rounded border border-zinc-700 text-gray-400 text-sm";
            document.getElementById('btn-delivery').className = t==='delivery' ? "p-2 rounded border border-yellow-500 bg-yellow-500/20 text-yellow-500 text-sm" : "p-2 rounded border border-zinc-700 text-gray-400 text-sm";
            if (t === 'mesa') { taxaEntregaAtual = 0; } else { atualizarTaxaEntrega(); }
            updateCartUI();
        }

        function carregarDadosLocais() {
            if(localStorage.getItem('rest_nome')) document.getElementById('input-nome').value = localStorage.getItem('rest_nome');
            if(localStorage.getItem('rest_tel')) document.getElementById('input-tel').value = localStorage.getItem('rest_tel');
            if(localStorage.getItem('rest_mesa')) document.getElementById('input-mesa').value = localStorage.getItem('rest_mesa');
        }
    </script>
</body>
</html>
