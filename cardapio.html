<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cardápio Digital - Black Piano</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #09090b; color: #f4f4f5; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #eab308; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .payment-option input:checked + div { border-color: #eab308; background-color: rgba(234, 179, 8, 0.1); }
    </style>
</head>
<body class="pb-24 select-none">

    <header id="header-area" class="relative h-48 bg-gray-800 bg-cover bg-center transition-all duration-500">
        <div class="absolute inset-0 bg-black/60"></div>
        <div class="absolute bottom-0 left-0 p-4 w-full flex items-end justify-between">
            <div class="flex items-center gap-3">
                <img id="store-logo" src="https://via.placeholder.com/60" class="w-16 h-16 rounded-full border-2 border-yellow-500 shadow-lg object-cover">
                <div>
                    <h1 id="store-name" class="text-2xl font-bold text-white tracking-tight">Carregando...</h1>
                    <p id="store-status" class="text-sm text-green-400 font-medium flex items-center gap-1">...</p>
                </div>
            </div>
        </div>
    </header>
    
    <div id="aviso-box" class="bg-yellow-600/20 border-l-4 border-yellow-500 p-3 mx-4 mt-4 text-sm text-yellow-200 hidden"></div>

    <nav class="sticky top-0 z-40 bg-[#09090b]/95 backdrop-blur-sm py-3 mt-2 border-b border-gray-800">
        <ul id="categories-list" class="flex gap-4 overflow-x-auto px-4 hide-scrollbar text-sm font-medium text-gray-400"></ul>
    </nav>

    <main id="products-container" class="p-4 space-y-8 min-h-[50vh]"></main>

    <button onclick="pedirAConta()" class="fixed bottom-24 right-4 bg-gray-800 border border-gray-700 text-white p-3 rounded-full shadow-xl hover:bg-gray-700 transition z-40 flex flex-col items-center">
        <i class="fa-solid fa-receipt text-xl"></i>
        <span class="text-[8px] font-bold uppercase mt-1">Conta</span>
    </button>

    <div id="cart-bar" class="fixed bottom-0 left-0 w-full bg-zinc-900 border-t border-zinc-800 p-4 transform translate-y-full transition-transform duration-300 z-50 shadow-2xl">
        <div class="flex justify-between items-center max-w-2xl mx-auto">
            <div>
                <p class="text-xs text-gray-400">Total do Pedido</p>
                <p id="cart-total" class="text-xl font-bold text-white">R$ 0,00</p>
            </div>
            <button onclick="openCheckout()" class="bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-2 px-6 rounded-lg transition shadow-lg shadow-yellow-500/20">
                Ver Carrinho <span id="cart-count" class="bg-black text-white text-xs px-2 py-0.5 rounded-full ml-1">0</span>
            </button>
        </div>
    </div>

    <div id="modal-checkout" class="fixed inset-0 z-[60] bg-black/90 hidden flex items-end sm:items-center justify-center p-0 sm:p-4">
        <div class="bg-zinc-900 w-full max-w-md h-[95vh] sm:h-auto rounded-t-2xl sm:rounded-2xl flex flex-col overflow-hidden border border-zinc-800">
            <div class="p-4 border-b border-zinc-800 flex justify-between items-center bg-zinc-950">
                <h2 class="text-lg font-bold text-white">Finalizar Pedido</h2>
                <button onclick="closeCheckout()" class="text-gray-400 hover:text-white"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-4 space-y-4">
                <div id="checkout-items" class="space-y-3"></div>
                <hr class="border-zinc-800">
                
                <div class="space-y-3">
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Seu Nome</label>
                        <input type="text" id="input-nome" class="w-full bg-zinc-800 border border-zinc-700 rounded p-2 text-white outline-none focus:border-yellow-500" placeholder="Como te chamamos?">
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">WhatsApp (DDD + Número)</label>
                        <input type="tel" id="input-tel" class="w-full bg-zinc-800 border border-zinc-700 rounded p-2 text-white outline-none focus:border-yellow-500" placeholder="(00) 00000-0000">
                    </div>
                    
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Onde você está?</label>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="setDeliveryType('mesa')" id="btn-mesa" class="p-2 rounded border border-yellow-500 bg-yellow-500/20 text-yellow-500 font-medium text-sm">Na Mesa</button>
                        <button onclick="setDeliveryType('delivery')" id="btn-delivery" class="p-2 rounded border border-zinc-700 text-gray-400 text-sm">Delivery</button>
                    </div>

                    <div id="area-mesa">
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1 mt-2">Número da Mesa</label>
                        <input type="number" id="input-mesa" class="w-full bg-zinc-800 border border-zinc-700 rounded p-2 text-white outline-none focus:border-yellow-500" placeholder="Ex: 10">
                    </div>

                    <div id="area-delivery" class="hidden space-y-3">
                        <div class="grid grid-cols-4 gap-2">
                            <div class="col-span-3">
                                <label class="block text-[10px] font-bold text-gray-500 uppercase">Rua / Avenida</label>
                                <input type="text" id="delivery-rua" class="w-full bg-zinc-800 border border-zinc-700 rounded p-2 text-white outline-none focus:border-yellow-500 text-sm">
                            </div>
                            <div class="col-span-1">
                                <label class="block text-[10px] font-bold text-gray-500 uppercase">Nº</label>
                                <input type="text" id="delivery-num" class="w-full bg-zinc-800 border border-zinc-700 rounded p-2 text-white outline-none focus:border-yellow-500 text-sm">
                            </div>
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 uppercase">Bairro</label>
                            <input type="text" id="delivery-bairro" class="w-full bg-zinc-800 border border-zinc-700 rounded p-2 text-white outline-none focus:border-yellow-500 text-sm">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 uppercase">Ponto de Referência</label>
                            <input type="text" id="delivery-ref" class="w-full bg-zinc-800 border border-zinc-700 rounded p-2 text-white outline-none focus:border-yellow-500 text-sm" placeholder="Perto de onde?">
                        </div>
                    </div>

                    <hr class="border-zinc-800">

                    <label class="block text-xs font-bold text-gray-400 uppercase">Forma de Pagamento</label>
                    <div class="grid grid-cols-2 gap-3">
                        <label class="payment-option cursor-pointer"><input type="radio" name="pagamento" value="pix" checked class="hidden"><div class="border border-zinc-700 rounded-lg p-3 text-center text-white text-xs font-bold">Pix</div></label>
                        <label class="payment-option cursor-pointer"><input type="radio" name="pagamento" value="cartao" class="hidden"><div class="border border-zinc-700 rounded-lg p-3 text-center text-white text-xs font-bold">Cartão</div></label>
                    </div>
                </div>
            </div>

            <div class="p-4 bg-zinc-950 border-t border-zinc-800">
                <button onclick="processarPedido()" id="btn-confirmar" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg shadow-lg hover:bg-green-500 transition active:scale-95">
                    Confirmar Pedido
                </button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://nbhpycsfnjgrhnwtzwsy.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5iaHB5Y3Nmbmpncmhud3R6d3N5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkxMTM2NzUsImV4cCI6MjA4NDY4OTY3NX0.LsNVvMG0gWuu7noJk-YnQTpTDRVQMHtqz1Li2nDgAxM';
        const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        const urlParams = new URLSearchParams(window.location.search);
        const LOJA_SLUG = urlParams.get('loja') || 'geral';

        let cart = [];
        let deliveryType = 'mesa';
        let produtosCache = [];

        document.addEventListener('DOMContentLoaded', async () => {
            await carregarLoja();
            await carregarProdutos();
            carregarDadosLocais();
        });

        async function carregarLoja() {
            const { data } = await client.from('restaurantes').select('*').eq('slug', LOJA_SLUG).single();
            if(data) {
                document.getElementById('store-name').innerText = data.nome;
                document.getElementById('store-status').innerText = data.aberto ? 'Aberto' : 'Fechado';
                if(data.banner_url) document.getElementById('header-area').style.backgroundImage = `url('${data.banner_url}')`;
                if(data.logo_url) document.getElementById('store-logo').src = data.logo_url;
            }
        }
        
        async function carregarProdutos() {
            const { data } = await client.from('produtos').select('*').eq('restaurante_slug', LOJA_SLUG).order('categoria');
            produtosCache = data || []; 
            renderizarProdutos(produtosCache);
        }

        function renderizarProdutos(produtos) {
            const container = document.getElementById('products-container');
            const nav = document.getElementById('categories-list');
            const porCategoria = {}; 
            const produtosFiltrados = produtos.filter(p => p.restaurante_slug === LOJA_SLUG);
            produtosFiltrados.forEach(p => { if(!porCategoria[p.categoria]) porCategoria[p.categoria]=[]; porCategoria[p.categoria].push(p); });
            container.innerHTML = ''; nav.innerHTML = '';
            for(const [cat, itens] of Object.entries(porCategoria)) {
                nav.innerHTML += `<li onclick="document.getElementById('cat-${cat}').scrollIntoView()" class="whitespace-nowrap cursor-pointer hover:text-white mr-4">${cat}</li>`;
                const htmlItens = itens.map(p => {
                    const esgotado = p.disponivel === false;
                    return `
                    <div class="flex gap-4 bg-zinc-900/50 p-3 rounded-lg border border-zinc-800 mb-3 relative overflow-hidden">
                        ${p.mostrar_promo ? '<div class="absolute top-0 right-0 bg-yellow-500 text-black text-[9px] font-black px-2 py-1 rounded-bl-lg">PROMO</div>' : ''}
                        <img src="${p.imagem_url || 'https://via.placeholder.com/80'}" class="w-20 h-20 rounded object-cover ${esgotado ? 'grayscale opacity-50' : ''}">
                        <div class="flex-1">
                            <h3 class="font-bold text-white text-sm">${p.nome}</h3>
                            <p class="text-[11px] text-gray-500 line-clamp-2">${p.descricao||''}</p>
                            <div class="flex justify-between items-center mt-2">
                                <span class="text-yellow-500 font-bold text-sm">R$ ${parseFloat(p.preco).toFixed(2)}</span>
                                ${esgotado 
                                    ? '<span class="text-[9px] bg-red-900/30 text-red-500 font-black px-2 py-1 rounded border border-red-900">ESGOTADO</span>' 
                                    : `<button onclick="addToCart('${p.id}')" class="bg-zinc-800 w-8 h-8 rounded-full text-white flex items-center justify-center"><i class="fa-solid fa-plus text-xs"></i></button>`
                                }
                            </div>
                        </div>
                    </div>`;
                }).join('');
                container.innerHTML += `<div id="cat-${cat}" class="mb-6"><h2 class="text-lg font-bold text-white mb-2 border-l-4 border-yellow-500 pl-2 tracking-tight">${cat}</h2>${htmlItens}</div>`;
            }
        }

        function addToCart(id) { 
            const prod = produtosCache.find(x => x.id === id && x.restaurante_slug === LOJA_SLUG);
            if(prod) { cart.push(prod); updateCartUI(); }
        }

        function updateCartUI() {
            document.getElementById('cart-total').innerText = 'R$ ' + cart.reduce((a,b)=>a+b.preco,0).toFixed(2);
            document.getElementById('cart-count').innerText = cart.length;
            const bar = document.getElementById('cart-bar');
            cart.length > 0 ? bar.classList.remove('translate-y-full') : bar.classList.add('translate-y-full');
        }

        async function processarPedido() {
            if (cart.length === 0) return;
            const nome = document.getElementById('input-nome').value;
            const telefone = document.getElementById('input-tel').value;
            const mesa = document.getElementById('input-mesa').value;
            const metodoPagamento = document.querySelector('input[name="pagamento"]:checked').value;

            if (!nome) return alert('Informe seu nome.');
            if (!telefone) return alert('Informe seu WhatsApp para avisarmos sobre o pedido.');
            
            let enderecoFinal = "";
            if (deliveryType === 'delivery') {
                const rua = document.getElementById('delivery-rua').value;
                const num = document.getElementById('delivery-num').value;
                const bairro = document.getElementById('delivery-bairro').value;
                const ref = document.getElementById('delivery-ref').value;

                if (!rua || !num || !bairro) return alert('Preencha os campos de endereço obrigatórios.');
                enderecoFinal = `Rua: ${rua}, Nº: ${num}, Bairro: ${bairro} | Ref: ${ref}`;
            } else {
                if (!mesa) return alert('Informe o número da mesa.');
            }

            const btn = document.getElementById('btn-confirmar');
            btn.disabled = true; btn.innerText = "Enviando...";

            try {
                const { error } = await client.from('pedidos').insert({
                    restaurante_slug: LOJA_SLUG,
                    cliente: nome,
                    mesa: deliveryType === 'mesa' ? mesa : null,
                    tipo_entrega: deliveryType,
                    itens: JSON.stringify(cart),
                    observacoes: enderecoFinal,
                    telefone: telefone,
                    total: cart.reduce((acc, item) => acc + item.preco, 0),
                    status: 'pendente',
                    status_pagamento: 'pendente',
                    metodo_pagamento: metodoPagamento
                });

                if (error) throw error;
                alert('Pedido enviado para a cozinha!');
                
                localStorage.setItem('rest_nome', nome);
                localStorage.setItem('rest_tel', telefone);
                if(deliveryType === 'mesa') localStorage.setItem('rest_mesa', mesa);
                
                cart = []; updateCartUI(); closeCheckout();
            } catch (e) { alert('Erro: ' + e.message); } finally { btn.disabled = false; btn.innerText = "Confirmar Pedido"; }
        }

        async function pedirAConta() {
            const mesa = localStorage.getItem('rest_mesa');
            if (!mesa) return alert('Nenhuma mesa identificada.');
            if(confirm(`Deseja solicitar a conta para a Mesa ${mesa}?`)) {
                await client.from('pedidos').update({ chamado_conta: true }).eq('mesa', mesa).eq('restaurante_slug', LOJA_SLUG).neq('status', 'concluido');
                alert('Garçom notificado!');
            }
        }

        function openCheckout() { document.getElementById('modal-checkout').classList.remove('hidden'); renderCheckoutItems(); }
        function closeCheckout() { document.getElementById('modal-checkout').classList.add('hidden'); }
        function renderCheckoutItems() {
            document.getElementById('checkout-items').innerHTML = cart.map((p,i) => 
                `<div class="flex justify-between bg-zinc-800 p-2 rounded items-center"><span class="text-white text-sm">${p.nome}</span><button onclick="cart.splice(${i},1);updateCartUI();renderCheckoutItems()" class="text-red-400 p-1"><i class="fa-solid fa-trash text-xs"></i></button></div>`
            ).join('');
            if(cart.length === 0) closeCheckout();
        }
        function setDeliveryType(t) {
            deliveryType = t;
            document.getElementById('area-mesa').classList.toggle('hidden', t !== 'mesa');
            document.getElementById('area-delivery').classList.toggle('hidden', t !== 'delivery');
            document.getElementById('btn-mesa').className = t==='mesa' ? "p-2 rounded border border-yellow-500 bg-yellow-500/20 text-yellow-500 text-sm" : "p-2 rounded border border-zinc-700 text-gray-400 text-sm";
            document.getElementById('btn-delivery').className = t==='delivery' ? "p-2 rounded border border-yellow-500 bg-yellow-500/20 text-yellow-500 text-sm" : "p-2 rounded border border-zinc-700 text-gray-400 text-sm";
        }
        function carregarDadosLocais() {
            if(localStorage.getItem('rest_nome')) document.getElementById('input-nome').value = localStorage.getItem('rest_nome');
            if(localStorage.getItem('rest_tel')) document.getElementById('input-tel').value = localStorage.getItem('rest_tel');
            if(localStorage.getItem('rest_mesa')) document.getElementById('input-mesa').value = localStorage.getItem('rest_mesa');
        }
    </script>
</body>
</html>